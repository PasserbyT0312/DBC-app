<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>otc交易界面</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/base.css" />
    <link rel="stylesheet" type="text/css" href="../../css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../css/touchslider.css" />
    <link rel="stylesheet" type="text/css" href="../../css/coin.css" />
    <script src="../../script/const.js"></script>
    <style>
        html,
        body {
            font-size: 16px;
            background: #fff;
        }
        /*.aui-bar-nav .aui-pull-right{
          height: 50px;
        }*/

        .com_head {
            /*position: fixed;
            top: 0;*/
        }

        .com_head>.title {
            font-size: 14px;
        }

        .title .active {
            font-size: 20px;
        }

        .title span {
            /*width: 30px;*/
            padding: 0 5px;
            -webkit-transition: all 300ms linear;
            -moz-transition: all 300ms linear;
            -o-transition: all 300ms linear;
            -ms-transition: all 300ms linear;
            transition: all 300ms linear;
        }

        .coin_type {
            /*height: 40px;*/
            background: #fff;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #F1F3F5;
            color: #8F9EAB;
            font-size: 14px;
            padding: 0 10px;
            /*position: fixed;
            top: 50px;
            left: 0;
            width: 100%;*/
        }

        .item_coin {
            padding: 10px 0;
            margin: 0 10px;
            border-bottom: 2px solid transparent;
        }

        .item_coin.active {
            color: #3F81CE;
            border-bottom: 2px solid #3F81CE;
        }
        /*.coin_list {
            padding-top: 90px;
        }*/

        .coin_list .item {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #F0F2F4;
        }

        .gray {
            font-size: 14px;
            color: #909FAC;
        }

        .top {
            color: #263E56;
            font-size: 14px;
        }

        .top .userImg {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        .bigSize {
            font-size: 18px;
            color: #3D80CE;
        }

        .payIcon {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            display: inline-block;
        }

        .buyCoin {
            background: #3D80CE;
            color: #fff;
            width: 100px;
            border-radius: 0.15rem;
            text-align: center;
            padding: 5px 0;
            font-size: 14px;
        }
        /*卖*/

        .sale_box {
            padding: 0 15px 10px;
        }

        .choose_coin>.item {
            width: 33.333%;
            margin-top: 10px;
            display: flex;
            float: left;
            height: 35px;
            line-height: 35px;
        }

        .choose_coin>.item>.con {
            width: 90%;
            /*margin: 0px auto;*/
            padding-left: 5px;
            color: #8F9EAB;
            border-radius: 5px;
            border: 1px solid #8F9EAB;
        }

        .choose_coin>.item>.con.active {
            border-color: #3D80CE;
            color: #3D80CE;
        }

        .choose_coin>.item>.con>img {
            width: 25px;
            height: 25px;
            position: relative;
            top: 5px;
            display: inline-block;
        }

        .choose_coin>.item>.con>span {
            position: relative;
            top: -3px;
            left: 5px;
        }

        .input-row {
            margin: 8px 0;
            font-size: 16px;
        }
        .input-row input[type="number"],.input-row input[type="password"]{
          height: 1.9rem;
        }
        .input-row input,
        .input-row input::-webkit-input-placeholder {
            font-size: 16px;
            color: #B5C0CF;
        }

        .input-row .coinName {
            margin-left: 10px;
            color: #B5C0CF;
        }

        .clickOrder {
            background: #3D80CE;
            width: 90%;
            color: #fff;
            height: 2.2rem;
            font-size: 16px;
        }

        .clickOrder:disabled {
            background: #C7CED4;
        }

        .myadv {
            font-size: 14px;
            margin-top: 25px;
            margin-bottom: 50px;
        }

        .input-box {
            border-bottom: 1px solid #DCE1E5;
        }

        .input-box .all {
            height: 100%;
            line-height: 1.9rem;
        }

        .payBox .userName {
            width: 100px;
        }

        .radio_type {
            width: 20px;
            height: 20px;
            -webkit-appearance: none;
            position: relative;
        }

        .radio_type:before {
            content: '';
            width: 15px;
            height: 15px;
            border: 2px solid #3F81CE;
            display: inline-block;
            border-radius: 50%;
            vertical-align: middle;
        }

        .radio_type:checked:before {
            content: '';
            width: 15px;
            height: 15px;
            border: 2px solid #3F81CE;
            display: inline-block;
            border-radius: 50%;
            vertical-align: middle;
        }

        .radio_type:checked:after {
            content: '';
            width: 9px;
            height: 9px;
            text-align: center;
            background: #3F81CE;
            border-radius: 50%;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-55%,-15%);
        }

        .radio_type:checked+label {
            color: #3F81CE;
        }
        .payBox .item{
          border-bottom: 1px solid #DCE1E5;
          padding: 10px 0;
          font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="app">
        <!--头部标题-->
        <header id="pack" class="aui-bar aui-bar-nav com_head">
            <div class="back_but" tapmode onclick="$A.closeWin('trade/otc_trade')"></div>
            <div class="aui-title titlePack title">
                <span :class="{'active':cur==0}" @click="change_type(0)">我要買</span>
                <span :class="{'active':cur==1}" @click="change_type(1)">我要賣</span>
            </div>
            <span class="aui-pull-right aui-iconfont aui-icon-cert" @click="orderList()" style="font-size:22px;"></span>
        </header>

        <div v-show="cur==0">
            <div class="coin_type">
                <div v-for="item in buyCoinList" class="item_coin b" :class="{'active':coinType==item.name}" @click="change_coin(item.name)">{{item.name}}</div>
            </div>
            <div id="otcList" style="overflow: auto">
                <div v-if="list.length>0" class="coin_list">
                    <div class="item" v-for="item in list">
                        <div class="top flex-box-between">
                            <div class="b"><img :src="item.head_img?item.head_img:'../../images/user.png'" alt="" class="userImg">{{item.truename}}</div>
                            <!-- <div class="gray">16783 | 99%</div> -->
                        </div>
                        <div class="middle flex-box-between">
                            <div class="gray">
                                <div>數量 {{item.balance}} {{item.coin_name}}</div>
                                <div>限額 ¥{{item.limit_min}} - ¥{{item.limit_max}}</div>
                            </div>
                            <div class="gray tx-r">
                                <div>單價</div>
                                <div class="bigSize">¥{{item.price}}</div>
                            </div>
                        </div>
                        <div class="last flex-box-between">
                            <div><img v-if="item.pay_bank" src="../../css/img/yhcard.png" alt="" class="payIcon"><img v-if="item.pay_alipay" src="../../css/img/alipay.png" alt="" class="payIcon"></div>
                            <div class="buyCoin" @click="buyCoin(item)">購買</div>
                        </div>
                    </div>
                </div>
                <div v-show="list.length==0" class="no_data">
                    <img src="../../images/no_data.png" alt="">
                    <p>暫無數據...</p>
                </div>
            </div>

        </div>
        <div v-show="cur==1" class="sale_box">
            <div class="choose_coin margin-b-15">
                <div class="item" v-for="(item,index) in coinList">
                    <div class="con" :class="{'active':coinId==item.name}" @click="chooseCoin(item)">
                        <img :src="item.img" onerror="this.src=image_load_error">
                        <span v-text="item.name"></span>
                    </div>
                </div>
                <div class="c"></div>
            </div>
            <div class="flex-box-between input-row"><label class="fs14">參考價格</label>
                <div>1 {{coinName}}≈{{coinPrice}} CNY</div>
            </div>
            <div class="input-row sellRow">
                <label class="fs14">交易單價 CNY</label>
                <div class="input-box">
                    <input type="number" v-model="price" placeholder="請輸入單價" class="flex-con">
                </div>
            </div>
            <div class="input-row">
                <label class="fs14">交易數量 {{coinName}}</label>
                <div class="input-box flex-box-between">
                    <input type="number" v-model="num" placeholder="請輸入數量" class="flex-con">
                    <div class="blue all" @click="allPush">全部</div>
                </div>
            </div>
            <div class="input-row">
                <label class="fs14">最小單筆限額 CNY</label>
                <div class="input-box flex-box-between">
                    <input type="number" v-model="minPrice" placeholder="最小單筆限額" class="flex-con">
                    <div class="coinName fs14">0.00{{coinName}}</div>
                </div>
            </div>
            <div class="input-row">
                <label class="fs14">最大單筆限額 CNY</label>
                <div class="input-box flex-box-between">
                    <input type="number" v-model="maxPrice" placeholder="最大單筆限額" class="flex-con">
                    <div class="coinName fs14">0.00{{coinName}}</div>
                </div>
            </div>
            <div class="input-row">
                <label class="fs14">交易密碼</label>
                <div class="input-box flex-box-between">
                    <input type="password" v-model="pwd" placeholder="請輸入交易密碼" class="flex-con">
                </div>
            </div>
            <div class="input-row">
                <label class="fs14">請選擇收款方式</label>
                <div class="payBox">
                    <div v-if="payList&&payList.bank" class="item flex-box-between">
                        <label for="card"><div>銀行卡</div><div><span class="userName">{{payList.bank.true_name}}</span>{{payList.bank.card}}</div></label>
                        <input type="checkbox" name="travel" class="radio_type" id="card" v-model="bankPay">
                    </div>
                    <div v-if="payList&&payList.alipay" class="item flex-box-between">
                        <label for="zfb"><div>支付寶</div><div><span class="userName">{{payList.alipay.true_name}}</span>{{payList.alipay.account}}</div></label>
                        <input type="checkbox" name="travel" class="radio_type" id="zfb" v-model="aliPay">
                    </div>
                </div>
            </div>
            <div class="tx-c  margin-b-10  margin-t-15">
                <button class="aui-btn clickOrder" type="button" @click="sellCoin">賣出</button>
            </div>

            <div class="tx-c myadv blue" @click="myAdv()">我的廣告</div>
        </div>

    </div>
</body>

<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="../../script/lib/base.js"></script>
<script type="text/javascript" src="../../script/lib/vue.js"></script>
<script>
    var app = new Vue({
            el: "#app",
            data: {
                cur: 0,
                coinType:'',
                coinList: [],
                coinId: '',
                price: '',
                num: 0.00,
                pwd: '',
                minPrice:'',
                maxPrice:'',
                coinName: '',
                coinPrice:'',
                userBalance:0,
                payList:{},
                bankPay:false,
                aliPay:false,
                page:1,
                list:[],
                buyCoinList:[],
                no_more: false       //是否有更多可以加载
            },
            mounted: function() {
                var $this = this;
                setTimeout(function() {
                    $this.get_data();
                      $this.getList();
                    set_scroll_div();
                    api.addEventListener({
                        name: 'changeOtcOrder'
                    }, function(ret, err) {
                        $this.list = [];
                        $this.page = 1;
                        $this.no_more=false;
                          $this.getList();
                    });
                }, 600)
            },
            methods: {
                //列表
                getList:function () {
                  var $this = this;
                  var tokens = api.getPrefs({
                      sync: true,
                      key: 'token'
                  });
                  var params = {
                      token: tokens,
                      coin_name: $this.coinType,
                      page: $this.page,
                  }
                  if ($this.no_more) {
                      return
                  }
                  $A.request('otc/get_all_list', params, function (data) {
                      if (data.length === 0) {
                          $this.no_more = true;
                          //$A.toast('没有数据了...')
                          return
                      }
                      $.each(data, function (i, obj) {
                          $this.list.push(obj)
                      })
                      $this.page += 1
                      $this.$forceUpdate()
                      $('#otcList').height($this.list.length * 160)
                  })
                },
                // 请求卖单拉取数据
                get_data: function() {
                    var $this = this;
                    var set_data = function(data) {
                        $this.coinList = data.coin_list;
                        $this.buyCoinList = data.coin_list;
                        $this.payList = data.pay_list;
                        $this.coinPrice = Object.values(data.coin_list)[0].cny;
                        $this.coinName = Object.values(data.coin_list)[0].name;
                        $this.coinId = Object.values(data.coin_list)[0].name;
                        $this.coinType = Object.values(data.coin_list)[0].name;
                        $this.num = Object.values(data.coin_list)[0].balance;
                        $this.userBalance = Object.values(data.coin_list)[0].balance;
                        // $this.$forceUpdate()
                    }
                    var tokens = api.getPrefs({
                        sync: true,
                        key: 'token'
                    });
                    var params = {
                        token: tokens
                    };
                    $A.request('otc/sale', params, set_data, set_data)
                },
                allPush:function() {
                  this.num = this.userBalance;
                },
                change_type: function(type) {
                    this.cur = type;
                },
                change_coin: function(type) {
                    this.coinType = type;
                    this.list = [];
                    this.page = 1;
                    this.no_more=false;
                    // $('#otcList').height(0)
                    this.getList()
                },
                buyCoin: function(item) {
                    api.openFrame({
                        name: 'buybox',
                        url: 'buybox.html',
                        rect: {
                            x: 0,
                            y: 0,
                            w: 'auto',
                            h: 'auto'
                        },
                        animation: {
                            type: "fade", //动画类型（详见动画类型常量）
                            subType: "from_bottom", //动画子类型（详见动画子类型常量）
                            duration: 300 //动画过渡时间，默认300毫秒
                        },
                        bounces: false,
                        pageParam: {
                            coin: item
                        },
                        bgColor: 'rgba(43,43,43,0.5)'
                    });
                },
                orderList: function() {
                    api.openFrame({
                        name: 'orderList',
                        url: '../trade/orderList.html'
                    });
                },
                chooseCoin: function(coin) {
                    this.coinId = coin.name;
                    this.coinName = coin.name;
                    this.coinPrice = coin.cny;
                    this.num = coin.balance;
                    this.userBalance = coin.balance;
                },
                sellCoin:function () {
                  var $this = this;
                  var tokens = api.getPrefs({
                      sync: true,
                      key: 'token'
                  });
                  if($this.price==''){
                    $A.toast('請填寫交易單價');
                    return false;
                  }else if($this.num==''){
                    $A.toast('請填寫交易數量');
                    return false;
                  }else if($this.minPrice==''){
                    $A.toast('請填寫最小單筆限額');
                    return false;
                  }else if($this.maxPrice==''){
                    $A.toast('請填寫最大單筆限額');
                    return false;
                  }else if($this.pwd==''){
                    $A.toast('請填寫交易密碼');
                    return false;
                  }else if(!$this.bankPay&&!$this.aliPay){
                    $A.toast('請至少選擇壹種支付方式');
                    return false;
                  }else{
                    var params = {
                        token: tokens,
                        price: $this.price,
                        amount: $this.num,
                        limit_min: $this.minPrice,
                        limit_max: $this.maxPrice,
                        pay_password: $this.pwd,
                        coin_name: $this.coinName,
                        is_bank: Number($this.bankPay),
                        is_alipay: Number($this.aliPay),
                    };
                    $A.request('otc/sale_handle', params, function(data) {
                          $A.toast('發布成功');
                          $this.price='';
                          $this.num='';
                          $this.minPrice='';
                          $this.maxPrice='';
                          $this.change_type(0);
                    })
                  }
                },
                myAdv:function () {
                  api.openFrame({
                      name: 'myAdv',
                      url: '../trade/myAdv.html'
                  });
                }
            }
        })
        // 设置滚到div标签
    function set_scroll_div() {
        var ID = 'otcList'
            // 设置列表高度
        var curr_height = $('.coin_type').height() + $('.com_head').height() + Number($api.getStorage('StatusBarHeight')) - 20
            // console.log($('.top').height());
            //   console.log($('.com_head').height());
            //     console.log(Number($api.getStorage('StatusBarHeight')));
        $('#' + ID).height(api.winHeight - curr_height)
        document.getElementById(ID).onscroll = function() {
            var scrollHeight = document.getElementById(ID).scrollHeight;
            var scrollTop = document.getElementById(ID).scrollTop;
            var clientHeight = document.getElementById(ID).clientHeight;
            if (scrollHeight - clientHeight === scrollTop) {
                //滚动条滚到最底部
                app.getList()
            }
        };
    }
</script>

</html>
